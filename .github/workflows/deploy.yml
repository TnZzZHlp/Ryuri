name: Deploy dev

on:
    push:
        branches: [dev]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "latest"

            - name: Build frontend
              run: |
                  cd frontend
                  npm install -g pnpm
                  pnpm install
                  pnpm build

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      ./backend/target
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo build
              uses: actions/cache@v4
              with:
                  path: |
                      target
                  key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Check toolchain
              run: rustc --version && cargo --version

            - name: Build backend (release)
              run: cd backend && cargo build --release

            - name: Upload backend binary artifact
              uses: actions/upload-artifact@v6
              with:
                  name: backend-binary
                  path: backend/target/release/backend
                  retention-days: 1

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Download backend binary artifact
              uses: actions/download-artifact@v6
              with:
                  name: backend-binary
                  path: backend/target/release/

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519

                  echo "Validating SSH key..."
                  if ! ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null 2>&1; then
                      echo "ERROR: Invalid SSH key format"
                      echo "Key file size: $(wc -c < ~/.ssh/id_ed25519)"
                      echo "First line: $(head -n 1 ~/.ssh/id_ed25519)"
                      exit 1
                  fi

                  echo "âœ“ SSH key is valid"
                  ssh-keygen -lf ~/.ssh/id_ed25519

                  ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
              shell: bash
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
                  SSH_HOST: ${{ secrets.SSH_HOST }}

            - name: Deploy to server
              env:
                  SSH_HOST: ${{ secrets.SSH_HOST }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
              run: |
                  mv target/release/backend target/release/ryuri
                  echo "Deploying to $SSH_HOST:$SSH_PORT"
                  # Test SSH connection with verbose output
                  ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o LogLevel=VERBOSE -p $SSH_PORT root@$SSH_HOST "echo 'SSH connection successful'"

                  # Ensure destination directories exist
                  ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p $SSH_PORT root@$SSH_HOST "mkdir -p /root/github/ryuri"

                  # Stop the service before replacing binary
                  ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p $SSH_PORT root@$SSH_HOST "systemctl stop ryuri || true"

                  # Upload ryuri binary
                  scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -P $SSH_PORT ryuri root@$SSH_HOST:/root/github/ryuri/ryuri

                  # Make binary executable
                  ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p $SSH_PORT root@$SSH_HOST "chmod +x /root/github/ryuri/ryuri"

                  # Start the service
                  ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p $SSH_PORT root@$SSH_HOST "systemctl start ryuri"

                  echo "Successfully deployed to $SSH_HOST:$SSH_PORT"
